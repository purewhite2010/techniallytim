<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Nginx, PHP-FPM, Wordpress, Super CacheTechnically Tim</title>

    <link rel="stylesheet" href="//tim.purewhite.id.au/theme/css/main.css">
    <link rel="stylesheet" href="//tim.purewhite.id.au/theme/css/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <div><img src="" class="grv-img"/></div>
        <div class="title"><a href="//tim.purewhite.id.au/">Technically Tim </a></div>
        <div class="sub-title"></div>

<p>
    <div class="view"><a href="//tim.purewhite.id.au/about.html">About</a></div>
  <div class="view"><a href="//tim.purewhite.id.au/archives.html">Archives</a></div>
</p>

<!-- Social links -->

      </header>
      <section>
<section id="content" class="body">
  <article>
      <div class="article-title">
        Nginx, PHP-FPM, Wordpress, Super Cache
      </div>

    <div class="entry-content">
<p>
<small>
<abbr class="published" title="2011-10-24T11:37:00+10:00">
  Mon 24 October 2011
</abbr> | 
  tags: 
    <a href="//tim.purewhite.id.au/tag/nginx">Nginx</a>, 
    <a href="//tim.purewhite.id.au/tag/php-fpm">php-fpm</a>, 
    <a href="//tim.purewhite.id.au/tag/secure">secure</a>, 
    <a href="//tim.purewhite.id.au/tag/supercache">supercache</a>, 
    <a href="//tim.purewhite.id.au/tag/try_files">try_files</a>, 
    <a href="//tim.purewhite.id.au/tag/wordpress">wordpress</a>, 
 -- (<a href="//tim.purewhite.id.au/2011/10/nginx-php-fpm-wordpress-super-cache/" rel="bookmark">permalink</a>)
</small>
</p>      <p>So recently I've been exploring the alternative world of Nginx instead
of Apache, and PHP-FPM instead of mod_php. There are plenty of
tutorials on the net for getting all of this setup, however not that
many are up to date anymore for the Super Cache stuff. Hopefully what I
present here will be a more up to date config, that is also mostly
secure compare to a good number of ones on the net (to do with passing
non PHP files to the php interpreter).</p>
<p>Firstly, my Nginx config for this very blog.</p>
<div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>
  <span class="kn">server_name</span> <span class="s">www.tim.purewhite.id.au</span><span class="p">;</span>
  <span class="kn">rewrite</span> <span class="s">^/(.*)</span> <span class="s">http://tim.purewhite.id.au/</span><span class="nv">$1</span> <span class="s">permanent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">server_name</span> <span class="s">tim.purewhite.id.au</span> <span class="s">static.tim.purewhite.id.au</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/home/tim/domains/tim.purewhite.id.au/public_html</span><span class="p">;</span>

    <span class="kn">access_log</span> <span class="s">/var/log/nginx/tim.purewhite.id.au_access_log</span><span class="p">;</span>
    <span class="kn">access_log</span>  <span class="s">/var/log/nginx/default.access.log</span> <span class="s">host_combined</span><span class="p">;</span>
    <span class="c1">#access_log  /var/log/nginx/uri.log host_combined_uri;</span>
    <span class="kn">error_log</span> <span class="s">/var/log/nginx/tim.purewhite.id.au_error_log</span><span class="p">;</span>

    <span class="kn">index</span> <span class="s">index.php</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>

        <span class="kn">if</span> <span class="s">(</span><span class="nv">$http_cookie</span> <span class="p">~</span> <span class="sr">&quot;comment_author_|wordpress|wp-postpass_&quot;)</span> <span class="p">{</span>
            <span class="kn">rewrite</span> <span class="s">^/(.*)</span> <span class="s">/loggedin</span><span class="nv">$1</span> <span class="s">last</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span>
        <span class="s">/wordpress/wp-content/cache/supercache/</span><span class="nv">$http_host/$uri/index.html</span>
        <span class="nv">$uri/</span>
        <span class="s">/index.php</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="s">/loggedin</span> <span class="p">{</span>
        <span class="kn">internal</span><span class="p">;</span>
        <span class="kn">rewrite</span> <span class="s">^/loggedin(.*)</span> <span class="s">/</span><span class="nv">$1</span> <span class="s">break</span><span class="p">;</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="nv">$uri/</span> <span class="s">/index.php</span><span class="p">;</span>
    <span class="p">}</span>


    <span class="kn">location</span> <span class="s">^~</span> <span class="s">/code</span> <span class="p">{</span>
            <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Server</span> <span class="nv">$host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Host</span> <span class="nv">$host</span><span class="p">;</span>
            <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://127.0.0.1:8080/code/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.(ico|css|js|gif|jpe?g|png)</span>$ <span class="p">{</span>
        <span class="kn">expires</span> <span class="s">1w</span><span class="p">;</span>
        <span class="kn">break</span><span class="p">;</span>
    <span class="p">}</span>



    <span class="kn">fastcgi_intercept_errors</span> <span class="no">off</span><span class="p">;</span>

    <span class="kn">location</span> <span class="p">~</span> <span class="sr">\.php</span> <span class="p">{</span>
        <span class="kn">try_files</span> <span class="nv">$uri</span> <span class="p">=</span><span class="mi">404</span><span class="p">;</span>
        <span class="kn">include</span> <span class="s">fastcgi_params</span><span class="p">;</span>
        <span class="kn">fastcgi_pass</span>   <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">9002</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kn">include</span> <span class="s">drop</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>The first thing to notice is line 1-4. This simply redirects everyone
from www.tim.purewhite.id.au to tim.purewhite.id.au. Simple as that.</p>
<p>Next we define the server and the root document path. Still very
standard. Then we define access logs, for various reason I'm logging to
more than one place, but that'll change once everything is finished.</p>
<p>Line 15 is boring, we just define the "index index.php" so that if you
access a directory it will load index.php or give you a 404 (which it
won't because of things further down).</p>
<p>Now for the fun. Lines 19-21. These catch a logged in user and send them
on an internal redirect down to lines 28-32. This is so we don't serve
cached content to logged in users. That little snippit is thanks to a
post at <a href="http://permalink.gmane.org/gmane.comp.web.nginx.english/15664">http://permalink.gmane.org/gmane.comp.web.nginx.english/15664</a>.</p>
<p>However, there was a problem in the rest of the code. Thanks to a post
at
<a href="http://wordpress.org/support/topic/lack-of-nginx-support-from-wp-super-cache">http://wordpress.org/support/topic/lack-of-nginx-support-from-wp-super-cache</a>
I realised we needed to test if the cache was being used or not. So I
added the extra logging and discovered it wasn't. I quickly worked out
what the problem was. The code at lines 22 - 25 had the middle 2 lines
swapped around. So "\$uri/" was before the supercache line. What this
mean was that it would try if the \$uri was a directory, and to load a
directory it would try index.php (due to the index line) and so would
end up loading wordpress through index.php. However, if we try the
supercache line first, we find the cache file and so don't need to load
indexes.</p>
<p>And just like that, magic, it works! We use supercache files for normal
users, and if a cache file doesn't exist, we load wordpress like normal!</p>
<p>I'm also looking at how we run Nginx and PHP-FPM. I have heard of a few
ways, one being that root runs a Nginx as user nginx or nobody, and each
user runs their own Nginx which we proxy to from the main one. (And
users run their own PHP-FPM as well). This sounds like a lot of work,
very complicated, but yes, it gives you absolute security as only the
user can access his web docs and scripts, and everything runs as that
user. No one else's php process can load your config file to discover
your database passwords.</p>
<p>Another way of running it is with Nginx as a nginx/nobody/www-data user,
and each user run their own php-fpm but give the nginx/nobody/www-data
user read only access to the web directory. If done correctly, this can
actually be very secure. First, (as root) you chgrp all the files and
directories in the users doc root (htdocs, www, public_html etc) to the
user nginx will run as. Ideally, you also only allow them read access
(so `chmod g+rX,g-w -R public_html` will give them access to read,
but not write). You then set the gid bit on the directory; `chmod g+s
public_html` (and do this for any directories that already exist
underneath). Now any files the user creates underneath the public_html
dir will be readable to the nginx user, so nginx can serve static files.
Now running php-fpm as each user (I use php-fpm with a pool per user),
the php process can read all the files that user can, so only the users
own php process can read their config files with the password in it! And
it also means that files you upload (i.e. wordpress media files) will be
owned by the user, not by www-data or what ever the web user is. This is
SO much better than Apache and mod_php, and easier than suExec with
mod_php.</p>
<p>Once I have more of my domains moved to Nginx, I'll do a report on
memory and cpu usage.</p>
    </div><!-- /.entry-content -->
  </article>
</section>
      </section>
      <footer>
        <p><small>&copy; Technically Tim &mdash; Theme based on Sundown by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <!-- Scale fix -->
    <script>
      var metas = document.getElementsByTagName('meta');
      var i;
      
      if (navigator.userAgent.match(/iPhone/i)) {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=1.0, maximum-scale=1.0";
          }
        }
      
        document.addEventListener("gesturestart", gestureStart, false);
      }

      function gestureStart() {
        for (i=0; i<metas.length; i++) {
          if (metas[i].name == "viewport") {
            metas[i].content = "width=device-width, minimum-scale=0.25, maximum-scale=1.6";
          }
        }
      }
    </script>
    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.whiteitsolutions.com.au/" : "http://piwik.whiteitsolutions.com.au/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 4);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://piwik.whiteitsolutions.com.au/piwik.php?idsite=4" style="border:0" alt="" /></p></noscript>
    <a href="https://github.com/timwhite/technicallytim"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>
  </body>
</html>